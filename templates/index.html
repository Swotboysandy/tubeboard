{% extends "base.html" %}
{% block title %}Accounts • YouTube Click Uploader{% endblock %}

{% block content %}
  <!-- Quick help -->
  <div class="card">
    <div class="card-h">
      <div class="card-title">Overview</div>
      <div class="flex">
        <a href="{{ url_for('account_form') }}" class="btn primary">+ Add Account</a>
        <button class="btn secondary" onclick="location.reload()">Refresh</button>
      </div>
    </div>
    <div class="subtle">
      Authorize once per account, then click <b>Run</b> to upload the next available video. Use <b>Browse Source</b> to scan, preview and choose a specific file.  
    </div>
  </div>

  {% for a in accounts %}
  <div class="card">
    <div class="card-h">
      <div class="flex" style="gap:14px">
        <div style="font-weight:700; font-size: 18px;">{{ a.name }}</div>
        {% if a.authed %}
          <span class="pill authed">Authorized</span>
        {% else %}
          <span class="pill notauthed">Not Authorized</span>
        {% endif %}
      </div>
      <div class="flex">
        <a href="{{ url_for('account_form', idx=loop.index0) }}" class="btn secondary">Edit</a>
        {% if a.authed %}
          {% if a.channel_url %}
            <a href="{{ a.channel_url }}" target="_blank" class="btn secondary">Open Channel</a>
          {% endif %}
          <button class="btn primary" onclick="runIdx({{ loop.index0 }})" title="Start upload">▶ Run</button>
        {% else %}
          <a href="{{ url_for('auth_start', idx=loop.index0) }}" class="btn primary">Authorize</a>
        {% endif %}
      </div>
    </div>

    <div class="row g2" style="margin-top:4px">
      <div>
        <div class="subtle">
          {% if a.channel_title %}Channel: <b>{{ a.channel_title }}</b> · {% endif %}
          Prefix: <code>{{ a.state_prefix }}</code>
        </div>
        <div class="spacer"></div>
        <!-- Last run status -->
        {% if a.status.status == "success" %}
          <div class="success">✔ Last run: {{ a.status.last_run }}</div>
          {% if a.status_parsed and a.status_parsed.video_url %}
            <div class="subtle">Uploaded: <a href="{{ a.status_parsed.video_url }}" target="_blank">{{ a.status_parsed.video_url }}</a></div>
          {% else %}
            <div class="subtle">Message: {{ a.status.message }}</div>
          {% endif %}
        {% elif a.status.status == "error" %}
          <div class="error">✘ Last run: {{ a.status.last_run }}</div>
          <div class="subtle">Message: {{ a.status.message }}</div>
        {% else %}
          <div class="subtle">Never run</div>
        {% endif %}
      </div>
      <div>
        <div class="subtle">Source: <a href="{{ a.video_base_url }}" target="_blank">{{ a.video_base_url }}</a></div>
        <div class="spacer"></div>
        <div class="flex">
          <button class="btn secondary" onclick="previewNext({{ loop.index0 }})">Preview Next Upload</button>
          <button class="btn secondary" onclick="toggleScan({{ loop.index0 }}, true)">Browse Source</button>
          <button class="btn secondary" onclick="toggleUsed({{ loop.index0 }}, true)">Show Used</button>
          <button class="btn danger"   onclick="clearUsed({{ loop.index0 }})">Clear Used</button>
        </div>
      </div>
    </div>

    <div id="preview-{{ loop.index0 }}" class="subtle" style="margin-top:10px"></div>

    <!-- Scan panel -->
    <div id="scan-wrap-{{ loop.index0 }}" style="margin-top:12px; display:none">
      <details open>
        <summary>Available Files</summary>
        <div class="details-body">
          <div class="flex" style="gap:8px; margin-bottom:10px;">
            <label class="hint">Limit</label>
            <input id="scan-limit-{{ loop.index0 }}" value="50" style="max-width:100px">
            <label class="hint">Include used</label>
            <select id="scan-include-{{ loop.index0 }}" style="max-width:140px">
              <option value="true">true</option>
              <option value="false" selected>false</option>
            </select>
            <button class="btn secondary" onclick="scanSource({{ loop.index0 }})">Rescan</button>
            <button class="btn ghost" onclick="toggleScan({{ loop.index0 }}, false)">Close</button>
            <span class="right hint">Pick a row to fill “Force Next”, then click Set.</span>
          </div>

          <div class="table-wrap">
            <div id="scan-{{ loop.index0 }}" class="subtle" style="padding:10px">No data yet… click Rescan.</div>
          </div>

          <div class="flex" style="margin-top:10px">
            <input id="force-name-{{ loop.index0 }}" placeholder="Type or pick exact filename (e.g. vid (12).mp4)" class="grow">
            <button class="btn primary" onclick="forceNext({{ loop.index0 }})">Set Force Next</button>
          </div>
        </div>
      </details>
    </div>

    <!-- Used list -->
    <div id="used-{{ loop.index0 }}" style="margin-top:12px; display:none">
      <details open>
        <summary>Used Filenames</summary>
        <div class="details-body">
          <div id="used-body-{{ loop.index0 }}" class="subtle">Loading…</div>
          <div class="spacer"></div>
          <button class="btn ghost" onclick="toggleUsed({{ loop.index0 }}, false)">Close</button>
        </div>
      </details>
    </div>
  </div>
  {% endfor %}
{% endblock %}

{% block scripts %}
<script>
function toggleScan(idx, show){ document.getElementById(`scan-wrap-${idx}`).style.display = show ? 'block':'none'; }
function toggleUsed(idx, show){ document.getElementById(`used-${idx}`).style.display = show ? 'block':'none'; }

async function runIdx(idx) {
  const btns = document.querySelectorAll('button');
  btns.forEach(b => b.disabled = true);
  try {
    const res = await fetch(`/run/${idx}`, {method: 'POST'});
    const data = await res.json();
    if (!res.ok) alert('Error: ' + (data.error || JSON.stringify(data)));
    else { toast('Started upload…'); setTimeout(()=>location.reload(), 1200); }
  } catch (e) {
    alert('Network error'); console.error(e);
  } finally {
    btns.forEach(b => b.disabled = false);
  }
}

async function previewNext(idx){
  const el = document.getElementById(`preview-${idx}`);
  el.textContent = 'Checking…';
  try {
    const res = await fetch(`/preview/${idx}`);
    const data = await res.json();
    if (data.next_video_url) {
      el.innerHTML = `Next video: <a href="${data.next_video_url}" target="_blank" rel="noopener">Open</a>`;
    } else {
      el.textContent = 'No usable video found (check base URL / filenames or manifest).';
    }
  } catch (e) {
    el.textContent = 'Error while checking preview.'; console.error(e);
  }
}

async function scanSource(idx){
  const limit = document.getElementById(`scan-limit-${idx}`).value || 50;
  const includeUsed = document.getElementById(`scan-include-${idx}`).value || 'false';
  const el = document.getElementById(`scan-${idx}`);
  el.textContent = 'Scanning…';

  try {
    const res = await fetch(`/scan/${idx}?limit=${encodeURIComponent(limit)}&include_used=${encodeURIComponent(includeUsed)}`);
    const rows = await res.json();
    if (!Array.isArray(rows)) { el.textContent = 'Error: ' + (rows.error || JSON.stringify(rows)); return; }
    if (rows.length === 0) {
      el.textContent = 'No files found. If you are not using a manifest, ensure your files are named vid.mp4 / vid (N).mp4 and accessible at the base URL.';
      return;
    }

    const html = `
      <table>
        <thead>
          <tr>
            <th>Pick</th><th>Name</th><th>Exists</th><th>Used</th><th>Force</th><th>URL</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td><input type="radio" name="pick-${idx}" value="${r.name}"
                         onchange="document.getElementById('force-name-${idx}').value=this.value"></td>
              <td style="white-space:nowrap">${r.name}</td>
              <td>${r.exists ? 'true' : 'false'}</td>
              <td>${r.used ? 'true' : 'false'}</td>
              <td>${r.is_force ? 'true' : 'false'}</td>
              <td>${r.url ? `<a href="${r.url}" target="_blank" rel="noopener">open</a>` : ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
    el.innerHTML = html;
  } catch (e) {
    el.textContent = 'Scan failed.'; console.error(e);
  }
}

async function forceNext(idx){
  const name = document.getElementById(`force-name-${idx}`).value.trim();
  if (!name) { alert('Type or select a filename first'); return; }
  try {
    const res = await fetch(`/force-next/${idx}`, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({name})
    });
    const data = await res.json();
    if (!res.ok) { alert('Error: ' + (data.error || JSON.stringify(data))); return; }
    toast('Force Next set: ' + data.forced);
  } catch (e) {
    alert('Network error'); console.error(e);
  }
}

async function loadUsed(idx){
  const el = document.getElementById(`used-body-${idx}`);
  el.textContent = 'Loading…';
  try {
    const res = await fetch(`/used/${idx}`);
    const data = await res.json();
    if (!res.ok) { el.textContent = 'Error: ' + (data.error || JSON.stringify(data)); return; }
    if (!Array.isArray(data) || data.length===0) { el.textContent = '(empty)'; return; }
    el.innerHTML = '<div style="max-height:240px; overflow:auto">' + data.map(n=>`<div>${n}</div>`).join('') + '</div>';
  } catch (e) {
    el.textContent = 'Failed to load.'; console.error(e);
  }
}

async function clearUsed(idx){
  if (!confirm('Clear used list for this account?')) return;
  try {
    const res = await fetch(`/used/${idx}/clear`, {method:'POST'});
    const data = await res.json();
    if (!res.ok) { alert('Error: ' + (data.error || JSON.stringify(data))); return; }
    toast('Used list cleared.');
    // If visible, refresh the used list
    const wrap = document.getElementById(`used-${idx}`);
    if (wrap.style.display !== 'none') loadUsed(idx);
  } catch (e) {
    alert('Network error'); console.error(e);
  }
}

function toggleUsed(idx, show){
  const el = document.getElementById(`used-${idx}`);
  el.style.display = show ? 'block' : 'none';
  if (show) loadUsed(idx);
}
</script>
{% endblock %}
